---
layout:     post
title:     记一次SQL查询语句
subtitle:   满足特定需求的一个SQL语句
date:       2018-05-01
author:     mengxun
header-img: img/pipenv.jpg
catalog: true
tags:
    - SQL
---


### 由来

项目里有个表结构就是类似下图这种表结构：

![](https://i.loli.net/2018/07/24/5b574cc3839da.png)

需求是：根据`时间戳`（timestamp）进行分组，然后输出这个`时间戳`下`状态`（status）为`hit`和`miss`的`请求数`的和和`流量`的和，返回json效果类似下面：
```json
[
    {
        "timestam": 1527782400,
        "hit": 24,
        "hitFlow": 241,
        "miss": 25,
        "missFlow": 251
    }，
     {
        "timestam": 1527782700,
        "hit": 26,
        "hitFlow": 261,
        "miss": 27,
        "missFlow": 271
    }
    ...
    
]

```

### 问题
这种需求如果只是单纯的`GROUP BY`的话，是可以求出每个时间戳下的请求以及流量的和。但是得到的和是该时间戳下所有status的总和，并不是拆成hit和miss的分别的和。

那怎么办呢，一时也没有思路（确实有段时间没写过原生SQL了），去谷歌了一下，受到了一些启发：可以用临时表的方法同时把两个select连接起来！！！

### 解决

费了一番力气，写了如下最终的SQL语句：

```sql
SELECT
	a.hit AS hit,
	a.hitflow AS hitflow,
	b.miss AS miss,
	b.missflow AS missflow,
	a.timestamp AS timestamp
FROM
	(
		SELECT
			sum(request) AS hit,
			sum(flow) AS hitflow,
			timestamp
		FROM
			statustable
		WHERE
			status = 'hit'
		GROUP BY
			timestamp
	) AS a,
	(
		SELECT
			sum(request) AS miss,
			sum(flow) AS missflow,
			timestamp
		FROM
			statustable
		WHERE
			status = 'miss'
		GROUP BY
			timestamp
	) AS b
WHERE
	a.timestamp = b.timestamp;
```

稍微解释一下上面的语句：单写select的话只能算sum(x)这种总和，并不能分情况，那么我就写了两个子seletc语句，每个语句里面输出三个字段，这样的话`hit`和`miss`两种情况就全了，然后还要根据`timestamp`进行分组，我这里用了`WHERE`筛选出`timestamp`相等的情况，如果不写最后的`WHERE`的话语句是下面这样的：

```sql
SELECT
	a.hit AS hit,
	a.hitflow AS hitflow,
	b.miss AS miss,
	b.missflow AS missflow,
	a.timestamp AS time1,
	b.timestamp AS time2
FROM
	(
		SELECT
			sum(request) AS hit,
			sum(flow) AS hitflow,
			timestamp
		FROM
			statustable
		WHERE
			status = 'hit'
		GROUP BY
			timestamp
	) AS a,
	(
		SELECT
			sum(request) AS miss,
			sum(flow) AS missflow,
			timestamp
		FROM
			statustable
		WHERE
			status = 'miss'
		GROUP BY
			timestamp
	) AS b;
```
输出如下：

![](https://i.loli.net/2018/07/25/5b5751d071877.png)

如果time1和time2不一样的话，那本来就分不到一个组里，直接舍弃；time1和time2一样的话，可以留下，这样就能用`WHERE`达到分组的效果了。最终的SQL语句就是第一个SQL语句，最终的输出就是这样：

![](https://i.loli.net/2018/07/25/5b57546b469d3.png)

虽然SQL语句忘的差不多了，不过最后好在还是写出来了。